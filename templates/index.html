<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mini-rag - ç¤¾å†…ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æ¤œç´¢</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans JP', sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                ğŸ” ç¤¾å†…ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æ¤œç´¢
            </h1>
            <p class="text-gray-600">RAGãƒ™ãƒ¼ã‚¹ã®è³ªå•å¿œç­”ã‚·ã‚¹ãƒ†ãƒ </p>
        </header>

        <!-- Ingest Section -->
        <div class="mb-6 bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-800">ğŸ“š æ–‡æ›¸å–ã‚Šè¾¼ã¿</h2>
                    <p class="text-sm text-gray-600 mt-1">docs/ é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã—ã¾ã™</p>
                </div>
                <button
                    hx-post="/ingest"
                    hx-target="#ingest-result"
                    hx-indicator="#ingest-spinner"
                    class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium"
                >
                    å–ã‚Šè¾¼ã¿å®Ÿè¡Œ
                </button>
            </div>
            <div id="ingest-spinner" class="htmx-indicator mt-4">
                <div class="flex items-center text-indigo-600">
                    <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    å‡¦ç†ä¸­...
                </div>
            </div>
            <div id="ingest-result" class="mt-4"></div>
        </div>

        <!-- Chat Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</h2>
            
            <!-- Suggested Prompts -->
            <div class="mb-4 flex flex-wrap gap-2">
                <button onclick="setPrompt('ã‚³ã‚¢ã‚¿ã‚¤ãƒ ã¯ä½•æ™‚ã‹ã‚‰ä½•æ™‚ã¾ã§ã§ã™ã‹ï¼Ÿ')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded-full transition-colors">
                    â° ã‚³ã‚¢ã‚¿ã‚¤ãƒ 
                </button>
                <button onclick="setPrompt('é…åˆ»ã®æ‰±ã„ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded-full transition-colors">
                    ğŸšƒ é…åˆ»ãƒ«ãƒ¼ãƒ«
                </button>
                <button onclick="setPrompt('çµŒè²»ç²¾ç®—ã®æ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded-full transition-colors">
                    ğŸ’° çµŒè²»ç²¾ç®—
                </button>
                <button onclick="setPrompt('éšœå®³ãŒç™ºç”Ÿã—ãŸã¨ãã®å¯¾å¿œæ‰‹é †ã¯ï¼Ÿ')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded-full transition-colors">
                    ğŸš¨ éšœå®³å¯¾å¿œ
                </button>
                <button onclick="setPrompt('ã‚¿ã‚¯ã‚·ãƒ¼ã¯ä½¿ãˆã¾ã™ã‹ï¼Ÿ')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded-full transition-colors">
                    ğŸš• ã‚¿ã‚¯ã‚·ãƒ¼åˆ©ç”¨
                </button>
                <button onclick="setPrompt('SHIPã‚³ãƒ¼ãƒ‰ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded-full transition-colors">
                    ğŸ“¦ ã‚³ãƒ¼ãƒ‰ãƒãƒ¼ãƒ 
                </button>
                <button onclick="setPrompt('APIã‚­ãƒ¼ã‚’èª¤ã£ã¦å…±æœ‰ã—ãŸå ´åˆã¯ã©ã†ã™ã‚Œã°ã„ã„ã§ã™ã‹ï¼Ÿ')" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded-full transition-colors">
                    ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
                </button>
            </div>
            
            <!-- Chat Log -->
            <div id="chat-log" class="mb-6 space-y-4 max-h-[600px] overflow-y-auto scroll-smooth">
                <div class="text-gray-500 text-sm text-center py-8">
                    è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                </div>
            </div>

            <!-- Input Form -->
            <form 
                id="chat-form"
                class="space-y-4"
                onsubmit="handleSubmit(event)"
            >
                <div class="flex gap-3">
                    <input
                        id="question-input"
                        type="text"
                        name="question"
                        placeholder="ä¾‹: å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ã¯ï¼Ÿ"
                        required
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                    <button
                        id="submit-btn"
                        type="submit"
                        class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span class="submit-text">é€ä¿¡</span>
                        <span class="submit-loading" style="display: none;">
                            <svg class="animate-spin h-5 w-5 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                </div>
                <div id="chat-spinner" style="display: none;">
                    <div class="flex items-center justify-center text-indigo-600 bg-indigo-50 rounded-lg p-4 border border-indigo-200">
                        <svg class="animate-spin h-6 w-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="font-medium">å›ç­”ã‚’ç”Ÿæˆä¸­...</span>
                    </div>
                </div>
            </form>
    <script>
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå€™è£œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«å…¥åŠ›æ¬„ã«è¨­å®š
        function setPrompt(text) {
            const input = document.getElementById('question-input');
            if (input) {
                input.value = text;
                input.focus();
            }
        }
    </script>
        </div>

        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>mini-rag powered by FastAPI + HTMX + OpenAI</p>
        </footer>
    </div>

    <style>
        .htmx-indicator {
            display: none;
        }
        .htmx-request .htmx-indicator {
            display: flex;
        }
        /* ãƒœã‚¿ãƒ³å†…ã®ã‚¹ãƒ”ãƒŠãƒ¼åˆ¶å¾¡ */
        #submit-btn.htmx-request .submit-text,
        #ingest-btn.htmx-request .ingest-text {
            display: none !important;
        }
        #submit-btn.htmx-request .submit-loading,
        #ingest-btn.htmx-request .ingest-loading {
            display: inline !important;
        }
    </style>
    <script>
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå€™è£œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«å…¥åŠ›æ¬„ã«è¨­å®š
        function setPrompt(text) {
            const input = document.getElementById('question-input');
            if (input) {
                input.value = text;
                input.focus();
            }
        }

        // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒãƒ£ãƒƒãƒˆé€ä¿¡å‡¦ç†
        function handleSubmit(event) {
            event.preventDefault();
            
            const input = document.getElementById('question-input');
            const submitBtn = document.getElementById('submit-btn');
            const spinner = document.getElementById('chat-spinner');
            const chatLog = document.getElementById('chat-log');
            const question = input.value.trim();
            
            if (!question) return;
            
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            submitBtn.disabled = true;
            submitBtn.querySelector('.submit-text').style.display = 'none';
            submitBtn.querySelector('.submit-loading').style.display = 'inline';
            spinner.style.display = 'block';
            
            // è³ªå•ã‚’è¡¨ç¤º
            const questionDiv = document.createElement('div');
            questionDiv.className = 'mb-4';
            questionDiv.innerHTML = `
                <div class="bg-indigo-100 rounded-lg p-4">
                    <p class="text-sm text-indigo-600 font-medium mb-1">ã‚ãªãŸã®è³ªå•</p>
                    <p class="text-gray-800">${escapeHtml(question)}</p>
                </div>
            `;
            chatLog.appendChild(questionDiv);
            
            // å›ç­”ã‚¨ãƒªã‚¢ã‚’ä½œæˆ
            const answerDiv = document.createElement('div');
            answerDiv.className = 'mb-6';
            answerDiv.innerHTML = `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <p class="text-sm text-gray-600 font-medium mb-2">ğŸ’¡ å›ç­”</p>
                    <div class="text-gray-800 whitespace-pre-wrap answer-content"></div>
                    <div class="references-content mt-4 pt-4 border-t border-gray-300" style="display: none;">
                        <p class="text-sm text-gray-600 font-medium mb-2">ğŸ“š å‚ç…§å…ƒ</p>
                        <ul class="space-y-1 references-list"></ul>
                    </div>
                </div>
            `;
            chatLog.appendChild(answerDiv);
            
            const answerContent = answerDiv.querySelector('.answer-content');
            const referencesContent = answerDiv.querySelector('.references-content');
            const referencesList = answerDiv.querySelector('.references-list');
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            chatLog.scrollTop = chatLog.scrollHeight;
            
            // SSEã§å›ç­”ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å—ä¿¡
            const formData = new FormData();
            formData.append('question', question);
            
            fetch('/chat/stream', {
                method: 'POST',
                headers: {
                    'Accept': 'text/event-stream',
                    'Cache-Control': 'no-cache',
                },
                cache: 'no-store',
                body: formData
            }).then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                function processLine(line) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.type === 'token') {
                                answerContent.textContent += data.content;
                                chatLog.scrollTop = chatLog.scrollHeight;
                            } else if (data.type === 'references') {
                                referencesContent.style.display = 'block';
                                data.references.forEach(ref => {
                                    const li = document.createElement('li');
                                    li.className = 'text-sm text-gray-700';
                                    const relatedness = Math.round((2.0 - ref.distance) / 2.0 * 100);
                                    li.innerHTML = `
                                        <span class="inline-block w-2 h-2 bg-indigo-400 rounded-full mr-2"></span>
                                        <span class="font-mono text-xs bg-gray-200 px-2 py-0.5 rounded">${escapeHtml(ref.source)}</span>
                                        <span class="text-gray-400 text-xs ml-1">(é–¢é€£åº¦: ${relatedness}%)</span>
                                    `;
                                    referencesList.appendChild(li);
                                });
                            } else if (data.type === 'done') {
                                // å®Œäº†
                                submitBtn.disabled = false;
                                submitBtn.querySelector('.submit-text').style.display = 'inline';
                                submitBtn.querySelector('.submit-loading').style.display = 'none';
                                spinner.style.display = 'none';
                                input.value = '';
                            } else if (data.type === 'error') {
                                answerContent.innerHTML = `<p class="text-red-600">ã‚¨ãƒ©ãƒ¼: ${escapeHtml(data.message)}</p>`;
                                submitBtn.disabled = false;
                                submitBtn.querySelector('.submit-text').style.display = 'inline';
                                submitBtn.querySelector('.submit-loading').style.display = 'none';
                                spinner.style.display = 'none';
                            }
                        } catch (e) {
                            console.error('Failed to parse SSE data:', line, e);
                        }
                    }
                }
                
                function readStream() {
                    reader.read().then(({done, value}) => {
                        if (done) {
                            // æ®‹ã‚Šã®ãƒãƒƒãƒ•ã‚¡ã‚’å‡¦ç†
                            if (buffer.trim()) {
                                processLine(buffer);
                            }
                            return;
                        }
                        
                        // ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ãƒãƒƒãƒ•ã‚¡ã«è¿½åŠ 
                        buffer += decoder.decode(value, {stream: true});
                        
                        // æ”¹è¡Œã§åˆ†å‰²ã—ã¦å‡¦ç†
                        const lines = buffer.split('\n');
                        // æœ€å¾Œã®è¡Œã¯ä¸å®Œå…¨ãªå¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§æ®‹ã™
                        buffer = lines.pop() || '';
                        
                        for (const line of lines) {
                            if (line.trim()) {
                                processLine(line);
                            }
                        }
                        
                        readStream();
                    });
                }
                
                readStream();
            }).catch(error => {
                answerContent.innerHTML = `<p class="text-red-600">ã‚¨ãƒ©ãƒ¼: ${escapeHtml(error.message)}</p>`;
                submitBtn.disabled = false;
                submitBtn.querySelector('.submit-text').style.display = 'inline';
                submitBtn.querySelector('.submit-loading').style.display = 'none';
                spinner.style.display = 'none';
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
